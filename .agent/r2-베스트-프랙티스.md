# R2 업로드 모범 사례

아키텍처 관점에서 **React(브라우저) → R2로 “직접 업로드”** 하고, **Hono 백엔드는 “업로드 권한(=presigned URL) 발급 + 사후 검증 + 메타데이터 관리”** 를 담당하는 구성이 일반적으로 가장 안정적이고 비용/성능 면에서도 유리합니다. Cloudflare R2 문서도 브라우저 기반 업로드 시 presigned URL 방식을 권장합니다. ([Cloudflare Docs][1])

---

## 1) 권장 아키텍처(표준 패턴)

### 흐름

1. **React → Hono**: `POST /uploads/init` (파일 메타: name/type/size 등)
2. **Hono**:
   - 인증/인가
   - 업로드 정책 검증(허용 MIME, 최대 크기, 사용자 쿼터, 파일 개수 제한 등)
   - **R2 presigned PUT URL 발급**(짧은 만료)
   - DB에 “업로드 세션(미완료)” 레코드 생성(예: uploadId, key, expectedSize, expectedType, userId, expiresAt)

3. **React → R2**: presigned URL로 **PUT 업로드(직접)**
4. **React → Hono**: `POST /uploads/complete` (uploadId, etag 등)
5. **Hono → R2**: `HEAD`(또는 메타 조회)로 **실제 업로드 결과 검증** 후 DB 상태를 “완료”로 전환
6. 다운로드는
   - **권한 필요한 경우**: Hono가 **GET presigned URL**을 발급하거나, Worker/Hono가 프록시 스트리밍
   - **공개 자산**: R2를 **custom domain**으로 퍼블릭 노출 + 캐시 전략 적용

presigned URL은 **bearer token처럼 취급**해야 하며, URL을 가진 누구든 만료 전까지 해당 작업을 수행할 수 있습니다. ([Cloudflare Docs][2])

---

## 2) 백엔드(Hono) 구현 모범 사례

### A. presigned URL 발급 시 보안/남용 방지

- **만료 시간을 짧게**: 수 분(예: 60~300초) 권장. presigned URL은 최대 7일까지 가능하지만(1초~7일) 보안 관점에서 짧게 가는 편이 안전합니다. ([Cloudflare Docs][3])
- **키(Key) 네이밍**: 사용자 입력 파일명을 그대로 키로 쓰지 말고
  - `uploads/{userId}/{yyyy}/{mm}/{uuid}` 같은 **충돌 없는 구조**
  - 원본 파일명은 DB 메타로 저장

- **Content-Type 고정(서명에 포함)**: `PutObjectCommand`에 `ContentType`을 지정하면, 클라이언트가 다른 `Content-Type`으로 올릴 때 서명 불일치로 실패하게 만들 수 있습니다. ([Cloudflare Docs][4])
- **CORS로 업로드 Origin 제한**: 버킷 CORS에서 허용 Origin/Method/Header를 최소화합니다. (아래 3절 참고) ([Cloudflare Docs][5])

> R2 presigned URL은 `POST(HTML form multipart)`를 지원하지 않으므로, 웹 업로드는 보통 `PUT` 기반으로 설계합니다. ([Cloudflare Docs][2])

### B. “사전 검증 + 사후 검증” 2단계로 생각하기

브라우저가 R2로 직접 올리면 백엔드가 업로드 바이트를 직접 보지 못합니다. 그래서:

- **사전(init 단계)**: size/type/유저 권한/쿼터 등 정책 검증
- **사후(complete 단계)**: R2 `HEAD`로 실제 `Content-Length`, `Content-Type`, `ETag` 등을 확인하고, 필요 시 비동기 검사(악성코드 스캔/파일 포맷 파싱)를 붙입니다.

### C. 업로드 완료 처리(complete)에서 권장 검증 항목

- 업로드 세션 존재/만료 여부
- 세션의 `key`와 요청 `uploadId` 매칭
- R2 `HEAD` 결과의
  - `size == expectedSize` (정확 매칭 또는 허용 오차 정책)
  - `Content-Type` 기대값과 일치 여부
  - `ETag` 저장(추후 무결성/캐시 디버깅에 도움)

CORS에서 `ETag`를 `ExposeHeaders`로 노출하면, 브라우저가 업로드 응답의 ETag를 읽어 complete 단계에 전달할 수 있습니다. ([Cloudflare Docs][5])

### D. 대용량/재시도(Resumable) 요구가 있으면 Multipart 업로드

- R2는 S3 Multipart Upload를 지원하지만 제약이 있습니다(파트 최소 5MiB 등). ([Cloudflare Docs][6])
- 미완료 multipart 업로드는 기본 7일 후 자동 abort되며, lifecycle로 조정 가능합니다. ([Cloudflare Docs][6])
- multipart ETag 동작은 S3와 유사하도록 맞춰졌습니다(2023-06-21 이후 업로드 기준). ([Cloudflare Docs][6])

실무 권장:

- **일반 업로드(수십~수백 MB 이하)**: 단일 PUT + 재시도(네트워크 오류 시 재시도)
- **수 GB 이상/재개 필수**: Multipart(파트별 presigned URL) 또는 Worker 기반 업로드 게이트웨이

---

## 3) R2 버킷 CORS 정책(브라우저 업로드 필수)

브라우저에서 presigned URL로 업로드하려면 **presigned URL 자체와 별개로 CORS 정책이 필요**합니다. CORS 없으면 브라우저가 차단합니다. ([Cloudflare Docs][5])

최소 예시(React 앱이 `https://app.example.com`에서 PUT 업로드):

```json
[
  {
    "AllowedOrigins": ["https://app.example.com"],
    "AllowedMethods": ["PUT"],
    "AllowedHeaders": ["Content-Type"],
    "ExposeHeaders": ["ETag"],
    "MaxAgeSeconds": 3600
  }
]
```

Cloudflare 문서도 presigned URL 사용 시 AllowedMethods/AllowedHeaders/ExposeHeaders(ETag) 등을 설정하라고 안내합니다. ([Cloudflare Docs][5])

---

## 4) Hono 실행 환경별 권장 구현

### 케이스 1) Hono가 Node/Bun/Deno 서버에서 동작

- **AWS SDK v3로 presigned URL 생성**이 가장 일반적입니다. Cloudflare 문서 예시도 `@aws-sdk/client-s3` + `getSignedUrl` 패턴을 사용합니다. ([Cloudflare Docs][3])
- S3 endpoint는 `https://<ACCOUNT_ID>.r2.cloudflarestorage.com`, region은 `auto`를 사용합니다. ([Cloudflare Docs][3])

### 케이스 2) Hono가 Cloudflare Workers에서 동작

- R2는 Workers에서 **R2 binding**으로 직접 접근 가능합니다(Hono의 `c.env` 바인딩). ([hono.dev][7])
- Workers 내부에서 S3 presigned URL을 만들려면 **aws4fetch 예시**가 Cloudflare 문서에 있습니다. ([Cloudflare Docs][8])
- 참고로 일부 개발자들이 “Workers에서 @aws-sdk가 그대로 안 된다”는 이슈를 보고하기도 하므로, Workers에서는 문서가 안내하는 방식(aws4fetch 등)을 우선 고려하는 편이 안전합니다. ([Cloudflare Docs][8])
- 또한 Cloudflare 문서에 따르면 `wrangler dev` 로컬 개발에서는 S3-compatible API 사용에 제한이 있습니다. ([Cloudflare Docs][4])

---

## 5) 다운로드/서빙(공개/비공개) 모범 사례

### 비공개 파일(권한 필요)

- 기본: **Hono에서 GET presigned URL 발급**(짧은 만료) ([Cloudflare Docs][3])
- 더 강한 통제 필요: Worker/Hono가 인증 후 R2에서 가져와 **스트리밍 프록시**(토큰 검사, rate limit, 워터마킹 등 가능)

### 공개 파일(이미지/정적 자산)

- R2를 **custom domain**으로 연결하면 Cloudflare 캐시를 적용할 수 있습니다. ([Cloudflare Docs][9])
- 캐시를 켜면 읽기 요청이 엣지 캐시에서 처리되어 지연이 줄지만, 최신 반영이 즉시 보장되지 않는 **일관성 트레이드오프**가 있을 수 있습니다. ([Cloudflare Docs][10])
- WAF/Access 같은 보안 기능을 쓰려면 `r2.dev`보다는 **custom domain 뒤에서 구성**하는 접근이 권장됩니다. ([Cloudflare Docs][9])

---

## 6) 실무 체크리스트(권장)

- **업로드 정책**
  - 허용 MIME/확장자 화이트리스트
  - 사용자별 최대 용량/일일 쿼터/동시 업로드 제한
  - presigned URL TTL(짧게)

- **오브젝트 키**
  - UUID 기반, 사용자 입력 파일명은 메타로만 보관
  - 임시(prefix `tmp/`) 업로드 후 검증 완료 시 최종 위치로 “승격”(copy+delete 전략)

- **검증/보안**
  - complete 단계에서 HEAD로 size/type 검증
  - 악성코드 스캔/포맷 검증은 비동기 파이프라인(Queue/Worker)로 분리

- **CORS**
  - AllowedOrigins/Methods/Headers 최소화, ETag 노출

- **대용량**
  - 5MiB 이상 파트, 동일 파트 크기(마지막 제외) 등 R2 multipart 제약 준수 ([Cloudflare Docs][6])

- **운영**
  - 미완료 업로드 정리(lifecycle)
  - 로그/추적: uploadId, key, userId, requestId 저장

---

원하시면, 현재 배포 형태가 **(1) Hono가 Workers인지, (2) Node 런타임인지**를 기준으로 “권장 엔드포인트 설계 + 최소 구현 코드(React 업로더/진행률 포함)”까지 한 세트로 정리해드리겠습니다.

[1]: https://developers.cloudflare.com/r2/objects/upload-objects/?utm_source=chatgpt.com "Upload objects - R2"
[2]: https://developers.cloudflare.com/r2/api/s3/presigned-urls/?utm_source=chatgpt.com "Presigned URLs · Cloudflare R2 docs"
[3]: https://developers.cloudflare.com/r2/api/s3/presigned-urls/ "Presigned URLs · Cloudflare R2 docs"
[4]: https://developers.cloudflare.com/r2/examples/aws/aws-sdk-js-v3/ "aws-sdk-js-v3 · Cloudflare R2 docs"
[5]: https://developers.cloudflare.com/r2/buckets/cors/ "Configure CORS · Cloudflare R2 docs"
[6]: https://developers.cloudflare.com/r2/objects/multipart-objects/?utm_source=chatgpt.com "Multipart upload - R2"
[7]: https://hono.dev/docs/getting-started/cloudflare-workers?utm_source=chatgpt.com "Cloudflare Workers"
[8]: https://developers.cloudflare.com/r2/examples/aws/aws4fetch/?utm_source=chatgpt.com "aws4fetch · Cloudflare R2 docs"
[9]: https://developers.cloudflare.com/r2/buckets/public-buckets/?utm_source=chatgpt.com "Public buckets · Cloudflare R2 docs"
[10]: https://developers.cloudflare.com/r2/how-r2-works/?utm_source=chatgpt.com "How R2 works"
